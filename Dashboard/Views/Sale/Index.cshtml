@model Dashboard.Models.AddSale
@*@model List<Dashboard.Models.Domain.Item>*@

@{
    Layout = "~/Views/Shared/_Invoice.cshtml";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Add</title>
    

</head>
<body>
    
     
    
    <div class="container">
      <header>Sale Window</header>

       

       <form asp-action="">
            

            <div class="form-first">
                <div class="details">
                    <span class=""></span>

                    <div class="fields">

                        <div class="input-field">
                            <label for="supplier">Supplier</label>
                            
                           @* @Html.DropDownListFor(model => model.Id, ViewBag.Items as SelectList,"Select an", new { @class = "form-first"})*@
                            <input type="text"  id="supplier" name="supplier"  placeholder="Supplier">
                           @* @Html.DropDownListFor(model => model.Id, ViewBag.Items as SelectList,"Select an", new { @class = "form-first"})*@

                        </div>

                        <div class="input-field">
                            <label for="pono">Po:No</label>
                            <input type="text" id="pono" name="pono" @*id="totalAmountInput"*@ placeholder="Enter po no:">

                        </div>

                        <div class="input-field">
                            <label for="invoiceno">Invoice:No</label>
                            <input type="text" id="invoiceno" name="invoiceno" placeholder="Enter invoice no:">

                        </div>

                        <div class="input-field">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" placeholder="Enter Date:">

                        </div>

                        <div class="input-field">
                            <label for="b2b">B2B Invoice:No</label>
                            <input type="text" id="b2b" name="b2b" placeholder="Enter B2Binvoice no:">

                        </div>
                        <div class="input-field">
                            <label for="b2c">B2C Invoice:No</label>
                            <input type="text" id="b2c" name="b2c" placeholder="Enter B2Cinvoice no:">

                        </div>
                        <div class="input-field">
                            <label for="account">A/C Type:</label>
                            <input type="text" id="account" name="account" placeholder="Enter A/C :">

                        </div>

                        <div class="input-fields">
                            <label for="address">Address</label>
                            <input type="text" id="address" name="address"  autocomplete="address-1" placeholder="Address">

                        </div>


                    </div>
                    @* <div class="figure">
                    <div class="form">
                    <label for="">Date</label>
                    <input type="date" placeholder="Supplier">

                    </div>
                    <div class="form">
                    <label for="">abc</label>
                    <input type="text" placeholder="Supplier">

                    </div>
                    <div class="form">
                    <label for="">bbc</label>
                    <input type="text" placeholder="Supplier">

                    </div>

                    </div>*@

                    <div class="table">


                        <table id="" class="table table-bordered">
                            <thead>
                                <tr>
                                    @*<th scope="col">#</th>*@
                                    <th>ID</th>
                                    <th>Particular</th>
                                    <th>Item.Code</th>
                                    <th>Barcode</th>
                                    <th>Batch:No</th>
                                    <th>MRP</th>
                                    <th>Qty</th>
                                    <th>P.Price</th>
                                    <th>S.Price</th>
                                    <th>Discount</th>
                                    <th>GST</th>
                                    <th>CGST</th>
                                    <th>SGST</th>
                                    <th>Total.amnt</th>
                                    <th>
                                        <button type="button" class="btn btn-sm btn-success"  onclick="addDetailRow()">+</button>

                                    </th>
                                </tr>
                            </thead>
                            <tbody id="itemDetailsTable">
                               
                                
                                <tr id="itemRow1" class="@*d-none*@">
                                    @*<th scope="col">1</th>*@
                                    <td><input style="width:40px;" type="text" name="Id" /></td>
                                    <td style="position: relative; width: 300px; left: 0;">
                                        <select id="itemNamePrefix1" onchange="fetchItemDetails(1)">
                                            <option value="">Select an Item Name</option>
                                            @foreach (var item in ViewBag.items)
                                            {
                                                <option value="@item">@item</option>
                                            }
                                        </select>
                                    </td>
                                    <td><input style="width:90px;" type="text" name="ItemCode" /></td>
                                    <td><input style="width:80px;" type="text" name="Barcode" /></td>
                                    <td><input style="width:70px;" type="text" name="Batch:No" /></td>
                                    <td><input style="width:70px;" type="text" name="MRP" /></td>
                                    <td><input style="width:40px;" type="text" id="qty_${rowCounter}"  name="Qty" data-row="${rowCounter}" class="qty-input" /></td>
                                    <td><input style="width:80px;" type="text" name="p.price" /></td>
                                    <td><input style="width:80px;" type="text" id="salePrice_${rowCounter}"  name="SalePrice" data-row="${rowCounter}" class="sale-price-input" /></td>
                                    <td><input style="width:60px;" type="text" name="Discount" /></td>
                                    <td><input style="width:60px;" type="text" name="GST" /></td>
                                    <td><input style="width:60px;" type="text" name="CGST" /></td>
                                    <td><input style="width:60px;" type="text" name="SGST" /></td>
                                    <td><input style="width:80px;" type="text" id="amt_${rowCounter}" name="Amt" data-row="${rowCounter}" class="amt-input" readonly /></td>
                                    <td class="NoPrint"><button type="button" class="btn btn-sm btn-danger" onclick="BtnDel(this)">X</button></td>

                                </tr>
                                
                               
                            </tbody>
                        </table>
                    </div>

                    
                    
                   

                    <div class="field">
                        
                        <div class="input-group">
                            
                            <label for="totalAmountInput">Total</label>
                            <input type="text" id="totalAmountInput" name="totalAmountInput" class="form-control text-end" value="0.00">
                        </div>
                        <div class="input-group">
                            <label for="fgst">T.Charge</label>
                            <input type="number" class="form-control text-end" id="fgst"  name="fgst" @*id="FGST" name="FGST" onchange="GetTotal()"*@>
                        </div>
                        <div class="input-group">
                            <label for="ftst">GST</label>
                            <input type="number" class="form-control text-end" id="ftst" name="ftst" onchange="GetTotal()">
                        </div>
                        <div class="input-group">
                            <label for="fnet">Grand Total</label>
                            <input type="number" class="form-control text-end" id="fnet" name="fnet" disabled="">
                        </div>
                        <div class="form-group">
                            <label for="currency">Currency</label>
                            <input type="text" id="currency" name="currency" class="form-control text-end">
                        </div>
                        <div class="form-group">
                            <label for="payment">Payment method</label>
                            <input type="text" id="payment" name="payment" class="form-control text-end">
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <input type="text"  id="notes"  name="notes" class="form-control text-end">
                        </div>


                    </div>

                    @*<div class="btn-group">
                    <button type="submit" >Print</button>
                    <button type="submit">Save</button>
                    </div>*@

                </div>
            </div>
            <div class="buttons">

                <div class="backBtn">
                    <i class="fa fa-arrow-alt-circle-right"></i>
                    <span class="btnText">Save</span>
                </div>

                <span class="submit">
                    <span class="submit">Print</span>
                    <i class="fa fa-arrow-alt-circle-right"></i>
                </span>
            </div>


        </form>
       <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

       <script>

            let rowCounter = 1; // Initialize row counter

            
            function addDetailRow() {
                console.log("Adding a new row");
                rowCounter++; // Increment row counter

                // Create a new row for item details
                const newRow = document.createElement('tr');
                newRow.id = `itemRow${rowCounter}`;
                newRow.innerHTML = `
                                        <td><input style="width:30px;" type="text" name="Id" /></td>
                                        <td style="position: relative; width: 400px; left: 0;">
                                          <select id="itemNamePrefix${rowCounter}" onchange="fetchItemDetails(${rowCounter})">
                                            <option value="">Select an Item Name</option>

                                                    @foreach (var item in ViewBag.items)
                                                       {
                                                                  <option value="@item">@item</option>
                                                       }
                                          </select>
                                        </td>
                                        <td><input style="width:90px;" type="text" name="ItemCode" /></td>
                                        <td><input style="width:80px;" type="text" name="Barcode" /></td>
                                        <td><input style="width:70px;" type="text" name="Batch:No" /></td>
                                        <td><input style="width:70px;" type="text" name="MRP" /></td>
                                        <td><input style="width:70px;" type="text" id="qty_${rowCounter}"  name="Qty" data-row="${rowCounter}" class="qty-input" onchange="calculateTotalAmount()"/></td>
                                        <td><input style="width:80px;" type="text" name="p.price" /></td>
                                        <td><input style="width:80px;" type="text" id="salePrice_${rowCounter}"   name="SalePrice" data-row="${rowCounter}" class="sale-price-input" onchange="calculateTotalAmount()" /></td>
                                        <td><input style="width:60px;" type="text" name="Discount" /></td>
                                        <td><input style="width:60px;" type="text" name="GST" /></td>
                                        <td><input style="width:60px;" type="text" name="CGST" /></td>
                                        <td><input style="width:60px;" type="text" name="SGST" /></td>
                                        <td><input style="width:60px;" type="text" id="amt_${rowCounter}" name="Amt" data-row="${rowCounter}"  class="amt-input" readonly  /></td>
                                        <!-- Add other input fields for item details here -->
                                        <td class="NoPrint"><button type="button" class="btn btn-sm btn-danger" onclick="removeDetailRow(${rowCounter})">X</button></td>
                                      `;

                // Append the new row to the table
                const itemDetailsTable = document.getElementById('itemDetailsTable');
                itemDetailsTable.appendChild(newRow);

                fetchItemDetails(rowCounter);


                calculateTotalAmount();
            }


            // Function to populate item names in the select element

            function removeDetailRow(row) {
                // Remove the specified row from the table
                const rowToRemove = document.getElementById(`itemRow${row}`);
                if (rowToRemove) {
                    rowToRemove.remove();
                    calculateTotalAmount(); // Recalculate total amount after removal
                }
            }


            fetchItemDetails(1);


            function fetchItemDetails(row) {
                const itemName = $(`#itemNamePrefix${row}`).val();
                const rowToPopulate = document.getElementById(`itemRow${row}`);

                if (itemName && rowToPopulate) {
                    $.ajax({
                        url: '/Sale/GetItemDetails',
                        type: 'POST',
                        data: { itemNamePrefix: itemName },
                        success: function (data) {
                            var totalAmount = 0;

                            // Populate the row with item details
                            data.forEach(function (item) {
                                rowToPopulate.innerHTML = `
                                    <td><input style="width:40px;" type="text" value="${item.id}" name="Id" /></td>
                                    <td><input style="width:300px;" type="text" value="${item.itemNameId}" name="ItemName" /></td>
                                    <td><input style="width:70px;" type="text" value="${item.itemCodeId}" name="Itemcode" /></td>
                                    <td><input style="width:70px;" type="text" value="${item.barcode}"  name="Barcode" /></td>
                                    <td><input style="width:70px;" type="text" value="${item.batchId}" name="Batch:No" /></td>
                                    <td><input style="width:60px;" type="text" value="${item.mrpId}" name="MRP" /></td>
                                    <td><input style="width:40px;" type="text" value="${item.openingQuantity}" id="qty_${rowCounter}" name="Qty" onchange="calculateTotalAmount()" /></td>
                                    <td><input style="width:60px;" type="text" value="${item.purchasePriceId}" name="p.price" /></td>
                                    <td><input style="width:60px;" type="text" value="${item.salePriceId}" id="salePrice_${rowCounter}" name="SalePrice"   onchange="calculateTotalAmount()" /></td>
                                    <td><input style="width:50px;" type="text" value="${item.salesDiscount}" name="Discount" /></td>
                                    <td><input style="width:40px;" type="text" value="${item.gstId}" name="GST" /></td>
                                    <td><input style="width:40px;" type="text" value="${item.cgst}" name="CGST" /></td>
                                    <td><input style="width:40px;" type="text" value="${item.sgst}" name="SGST" /></td>
                                    <td><input style="width:70px;" type="text" value="${(item.openingQuantity * item.salePriceId).toFixed(2)}" name="Amt" readonly /></td>
                                    <td class="NoPrint"><button type="button" class="btn btn-sm btn-danger" onclick="removeDetailRow(${rowCounter})">X</button></td>
                                `;

                                totalAmount += item.openingQuantity * item.salePriceId;
                            });

                            // Update the total amount input field
                            document.getElementById('totalAmountInput').value = totalAmount.toFixed(2);
                        }
                    });
                }
            }

            
            function calculateTotalAmount() {
                var totalAmount = 0;

                for (let i = 1; i <= rowCounter; i++) {
                    const quantityInput = document.querySelector(`#qty_${i}`);
                    const salePriceInput = document.querySelector(`#salePrice_${i}`);

                    if (quantityInput && salePriceInput) {
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const salePrice = parseFloat(salePriceInput.value) || 0;

                        // Calculate the row total for this row
                        

                        // Add the row total to the totalAmount
                        totalAmount += quantity * salePrice;
                    }
                }

                console.log('total amount',totalAmount);

                // Update the total amount input field
                document.getElementById('totalAmountInput').value = totalAmount.toFixed(2);
            }
            
            

            


        </script>


    </div>
    
</body>


</html>

